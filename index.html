<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF Photo Plotter with Road Paths</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">

    <script src="https://d3js.org/d3.v7.min.js"></script>

    <link href="style.css" rel="stylesheet">
</head>

<body>
<div class="main" style="margin-top: .25rem;">
    <div class="mb-4">
        <div class="card-header text-bg-light">
            <h5 class="card-title mb-0">EXIF Photo Plotter with Road Paths</h5>
        </div>

        <div class="card-body">
            <div class="row">
                <!-- Image and Input Section -->
                <div class="col-md-4 image-section">
                    <div class="container text-center">
                        <div class="row">
                            <div class="col">
                                <!-- Hidden file input -->
                                <input type="file" id="imageInput" class="d-none" multiple accept="image/*" onchange="handleImageInput(this);" />
                                <!-- Label styled as Bootstrap icon button -->
                                <label for="imageInput" style="margin-top: 5rem;"class="btn btn-primary">
                                    <i style="font-size: 3S0px;" class="bi bi-plus">Add Image</i>
                                </label>
                            </div>
                            <div class="col">
                                <div class="loading-spinner" id="loadingSpinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span>Calculating road path...</span>
                                </div>
                                <div id="pathInfo" class="path-info mt-3" style="display: none;">
                                    <strong>Total Distance:</strong> <span id="totalDistance">0 km</span>
                                </div>
                               
                            </div>
                        </div>
                    </div>
                     <h5 style="margin-top: 1rem;">Photo Gallery</h5>
                    <div id="photoCards"></div>
                </div>
                <div class="col-md-8">
                    <!-- Map Section -->

                        <!--Undo Redo Functions-->
                        <div class="btn-group mt-3">
                            <button class="btn btn-secondary" onclick="undoAdd()">
                                <i class="bi bi-arrow-counterclockwise"></i> Undo
                            </button>
                            <button class="btn btn-secondary" onclick="redoAdd()" style="margin-left:5px">
                                <i class="bi bi-arrow-clockwise"></i> Redo
                            </button>
                        </div>
                    
                    <button id="clearButton" class="btn btn-danger mt-3" type="button" onclick="clearMap()">Clear Map</button>
                    <div id="timeInfo" class="time-info mt-3" style="display: none;">
                        <strong>Time Between Photos:</strong> <span id="timeDifference">N/A</span>
                    </div>
                    <div id="map" class="mt-5"></div>
                    <div class="card mt-4">
                    <div class="card-header">
                        <strong>Photo Node Visualization</strong>
                    </div>
                    <div class="card-body">
                        <svg id="nodeGraph" width="100%" height="300"></svg>
                    </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<script>
/*
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('Service Worker registered:', reg.scope))
      .catch(err => console.error('Service Worker failed:', err));
  });
}*/
</script>
<script>
console.log("Script Added");

class PhotoNode {
    constructor(photo) {
        this.data = photo;
        this.next = null;
    }
}

class PhotoLinkedList {
    constructor() {
        this.head = null;
        this.length = 0;
    }

    insert(photo) {
        const node = new PhotoNode(photo);
        if (!this.head) {
            this.head = node;
            console.log("Added photo node");
        } else {
            let cur = this.head;
            while (cur.next) cur = cur.next;
            cur.next = node;
        }
        this.length++;
    }

    removeLast() {
        if (!this.head) return null;

        if (!this.head.next) {
            const removed = this.head.data;
            this.head = null;
            this.length--;
            console.log("Removed photo node");
            return removed;
        }

        let cur = this.head;
        while (cur.next.next) cur = cur.next;

        const removed = cur.next.data;
        cur.next = null;
        this.length--;
        return removed;
    }

    clear() {
        this.head = null;
        this.length = 0;
    }

    findById(id) {
        let cur = this.head;
        while (cur) {
            if (cur.data.id == id) return cur.data;
            cur = cur.next;
        }
        return null;
    }

    forEach(cb) {
        let cur = this.head;
        while (cur) {
            cb(cur.data);
            cur = cur.next;
        }
    }

    toArray() {
        const arr = [];
        this.forEach(p => arr.push(p));
        return arr;
    }
}

//Globals

const photoList = new PhotoLinkedList();
const undoStack = [];
const redoStack = [];

let markers = [];
let areaPolygon = null;

const myMap = L.map('map').setView([11.63523, 123.7079], 5);
const spinner = document.getElementById("loadingSpinner");

//Map

function initMap() {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(myMap);
}

document.addEventListener("DOMContentLoaded", initMap);

//Image Input

async function handleImageInput(input) {
    if (!input.files.length) return;

    spinner.style.display = "block";

    for (const file of input.files) {
        await processImage(file);
    }

    spinner.style.display = "none";
    refreshUI();
}

function processImage(file) {
    return new Promise(resolve => {
        const reader = new FileReader();

        reader.onload = e => {
            EXIF.getData(file, function () {

                const lat = EXIF.getTag(this, "GPSLatitude");
                const lon = EXIF.getTag(this, "GPSLongitude");
                if (!lat || !lon) return resolve();

                const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "W";

                const calcLat = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "N" ? 1 : -1);
                const calcLon = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

                let dateObj = null;
                const date = EXIF.getTag(this, "DateTimeOriginal");
                if (date) {
                    const [d,t] = date.split(" ");
                    dateObj = new Date(d.replace(/:/g,"-") + "T" + t);
                }

                const photo = {
                    id: Date.now() + Math.random(),
                    src: e.target.result,
                    lat: calcLat,
                    lon: calcLon,
                    dateObj,
                    filename: file.name,
                    formattedDate: dateObj ? dateObj.toLocaleString() : "Unknown"
                };

                photoList.insert(photo);
                undoStack.push(photo);
                redoStack.length = 0;

                resolve();
            });
        };

        reader.readAsDataURL(file);
    });
}

// Stack Undo Redo

function undoAdd() {
    if (!undoStack.length) return;

    const removed = photoList.removeLast();
    if (!removed) return;

    redoStack.push(removed);
    console.log("Removed photo node from stack");
    refreshUI();
}

function redoAdd() {
    if (!redoStack.length) return;

    const photo = redoStack.pop();
    photoList.insert(photo);
    undoStack.push(photo);
    console.log("Added photo node to stack");
    refreshUI();
}

//UI

function refreshUI() {
    updatePhotoCards();
    drawPaths();
    updateTimeDiff();
    renderNodeGraph(); 
}


function updatePhotoCards() {
    const container = document.getElementById("photoCards");
    container.innerHTML = "";

    photoList.forEach(p => {
        const card = document.createElement("div");
        card.className = "photo-card";
        card.onclick = () => focusOnPhoto(p.id);

        card.innerHTML = `
            <div class="row">
                <div class="col-4">
                    <img src="${p.src}" class="fixed-img">
                </div>
                <div class="col-8">
                    <strong>${p.filename}</strong><br>
                    ${p.formattedDate}<br>
                    <small>${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}</small>
                    <hr>
                </div>
                
            </div>
            
            
        `;

        container.appendChild(card);
    });
}

//Map Draw

function focusOnPhoto(id) {
    const p = photoList.findById(id);
    if (!p) return;

    myMap.setView([p.lat, p.lon], 15);
    const m = markers.find(x => x.photoId == id);
    if (m) m.openPopup();
}

async function drawPaths() {
    // Clear old layers
    markers.forEach(m => myMap.removeLayer(m));
    markers = [];
    if (areaPolygon) myMap.removeLayer(areaPolygon);

    const arr = photoList.toArray();
    if (!arr.length) return;

    // Sort by time (optional but useful)
    arr.sort((a, b) => (a.dateObj || 0) - (b.dateObj || 0));

    // Add markers
    arr.forEach(p => {
        const m = L.marker([p.lat, p.lon])
            .addTo(myMap)
            .bindPopup(`<b>${p.filename}</b><br>${p.formattedDate}`);
        m.photoId = p.id;
        markers.push(m);
    });

    // Need at least 3 points for polygon
    if (arr.length < 3) return;

    // Convert to [lat, lon]
    const points = arr.map(p => [p.lat, p.lon]);

    // Compute convex hull
    const hull = convexHull(points);

    // Draw polygon
    areaPolygon = L.polygon(hull, {
        color: "green",
        fillColor: "#3cb371",
        fillOpacity: 0.3,
        weight: 3
    }).addTo(myMap);

    myMap.fitBounds(areaPolygon.getBounds());
}

function convexHull(points) {
    if (points.length <= 3) return points;

    // Sort points by latitude, then longitude
    points = points.slice().sort((a, b) =>
        a[0] === b[0] ? a[1] - b[1] : a[0] - b[0]
    );

    const cross = (o, a, b) =>
        (a[0] - o[0]) * (b[1] - o[1]) -
        (a[1] - o[1]) * (b[0] - o[0]);

    const lower = [];
    for (const p of points) {
        while (lower.length >= 2 &&
            cross(lower[lower.length - 2], lower[lower.length - 1], p) <= 0) {
            lower.pop();
        }
        lower.push(p);
    }

    const upper = [];
    for (let i = points.length - 1; i >= 0; i--) {
        const p = points[i];
        while (upper.length >= 2 &&
            cross(upper[upper.length - 2], upper[upper.length - 1], p) <= 0) {
            upper.pop();
        }
        upper.push(p);
    }

    upper.pop();
    lower.pop();
    return lower.concat(upper);
}


// Time

function updateTimeDiff() {
    const arr = photoList.toArray().filter(p => p.dateObj);
    if (arr.length < 2) return;

    arr.sort((a,b) => a.dateObj - b.dateObj);
    const diff = Math.abs(arr[arr.length-1].dateObj - arr[0].dateObj);
    const mins = Math.floor(diff / 60000);

    document.getElementById("timeDifference").innerText = mins + " minutes";
    document.getElementById("timeInfo").style.display = "block";
}

// Reset Map

function clearMap(reset = true) {
    markers.forEach(m => myMap.removeLayer(m));
    markers = [];
    if (areaPolygon) myMap.removeLayer(areaPolygon);


    photoList.clear();
    undoStack.length = 0;
    redoStack.length = 0;

    document.getElementById("photoCards").innerHTML = "";
    document.getElementById("timeInfo").style.display = "none";

    if (reset) document.getElementById("imageInput").value = "";
    myMap.setView([11.63523, 123.7079], 5);

    d3.select("#nodeGraph").selectAll("*").remove();

}

</script>

<script>
function buildGraphData() {
    const arr = photoList.toArray()
        .sort((a, b) => (a.dateObj || 0) - (b.dateObj || 0));

    const nodes = arr.map((p, i) => ({
        id: p.id,
        label: p.filename,
        index: i
    }));

    const links = [];
    for (let i = 0; i < nodes.length - 1; i++) {
        links.push({
            source: nodes[i].id,
            target: nodes[i + 1].id
        });
    }

    return { nodes, links };
}
function renderNodeGraph() {
    const svg = d3.select("#nodeGraph");
    svg.selectAll("*").remove();

    const width = svg.node().clientWidth;
    const height = svg.node().clientHeight;

    const { nodes, links } = buildGraphData();
    if (!nodes.length) return;

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(60))
        .force("charge", d3.forceManyBody().strength(-150))
        .force("center", d3.forceCenter(width / 2, height / 2));

    const link = svg.append("g")
        .attr("stroke", "#999")
        .attr("stroke-opacity", 0.6)
        .selectAll("line")
        .data(links)
        .join("line");

    const node = svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", 8)
        .attr("fill", "#0d6efd")
        .call(drag(simulation))
        .on("click", (_, d) => focusOnPhoto(d.id));

    const label = svg.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .text(d => d.index + 1)
        .attr("font-size", "10px")
        .attr("dx", 12)
        .attr("dy", 4);

    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

        label
            .attr("x", d => d.x)
            .attr("y", d => d.y);
    });
}
function drag(simulation) {
    return d3.drag()
        .on("start", event => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        })
        .on("drag", event => {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        })
        .on("end", event => {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        });
}

</script>
</body>
</html>