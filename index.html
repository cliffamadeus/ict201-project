<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF Photo Plotter with Road Paths</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .main {
            width: 95%;
            margin-left: 3%;
            justify-content: center;
        }
        .image-preview {
            width: 200px;
        }
        .image-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #photoCards {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 15px;
            padding: 10px;
        }
        .photo-card {
            cursor: pointer;
            margin-bottom: 10px;
            padding: 10px;
            transition: all 0.2s;
        }
        .photo-card:hover {
            background-color: #f8f9fa;
        }
        .photo-card img {
            width: 100%;
            height: auto;
            border-radius: 3px;
        }
        .photo-card.active {
            background-color: #e9f7fe;
            border-color: #86b7fe;
        }
        .path-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        #map {
            height: 500px;
        }
        .time-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .loading-spinner {
            display: none;
            margin-top: 10px;
        }
        .fixed-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        @media (min-width: 768px) {
            .fixed-img {
            height: 200px;
            }
        }
                
    </style>
</head>

<body>
<div class="main" style="margin-top: .25rem;">
    <div class="mb-4">
        <div class="card-header text-bg-light">
            <h5 class="card-title mb-0">EXIF Photo Plotter with Road Paths</h5>
        </div>

        <div class="card-body">
            <div class="row">
                <!-- Image and Input Section -->
                <div class="col-md-4 image-section">
                    <div class="container text-center">
                        <div class="row">
                            <div class="col">
                                <!-- Hidden file input -->
                                <input type="file" id="imageInput" class="d-none" multiple accept="image/*" onchange="handleImageInput(this);" />
                                <!-- Label styled as Bootstrap icon button -->
                                <label for="imageInput" style="margin-top: 5rem;"class="btn btn-primary">
                                    <i style="font-size: 3S0px;" class="bi bi-plus">Add Image</i>
                                </label>
                            </div>
                            <div class="col">
                                <div class="loading-spinner" id="loadingSpinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span>Calculating road path...</span>
                                </div>
                                <div id="pathInfo" class="path-info mt-3" style="display: none;">
                                    <strong>Total Distance:</strong> <span id="totalDistance">0 km</span>
                                </div>
                                <div id="timeInfo" class="time-info mt-3" style="display: none;">
                                    <strong>Time Between Photos:</strong> <span id="timeDifference">N/A</span>
                                </div>
                            </div>
                        </div>
                    </div>
                  
                     
                     <h5 style="margin-top: 1rem;">Photo Gallery</h5>
                    <div id="photoCards"></div>
                </div>
                <div class="col-md-8">
                     <!-- Map Section -->
                    <button id="clearButton" class="btn btn-danger mt-3" type="button" onclick="clearMap()">Clear Map</button>
                    <div id="map" class="mt-5"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>


class PhotoNode {
    constructor(photo) {
        this.data = photo;   // photo object
        this.next = null;    // next node
    }
}

class PhotoLinkedList {
    constructor() {
        this.head = null;
        this.length = 0;
    }

    insert(photo) {  
        const newNode = new PhotoNode(photo);

        if (!this.head) {
            this.head = newNode;
        } else {
            let current = this.head;
            while (current.next !== null) {
                current = current.next;
            }
            current.next = newNode;
        }

        this.length++;
    }

    toArray() {
        const arr = [];
        let current = this.head;
        while (current !== null) {
            arr.push(current.data);
            current = current.next;
        }
        return arr;
    }

    clear() {
        this.head = null;
        this.length = 0;
    }

    findById(id) {
        let current = this.head;
        while (current !== null) {
            if (current.data.id === id) return current.data;
            current = current.next;
        }
        return null;
    }

    forEach(callback) {
        let current = this.head;
        while (current !== null) {
            callback(current.data);
            current = current.next;
        }
    }
}


// GLOBAL VARIABLES
const myMap = L.map('map').setView([11.635230398105993, 123.70790316297406], 5);
const photoList = new PhotoLinkedList();   // â¬… Linked list replaces array
let markers = [];
let pathPolyline = null;
let totalDistance = 0;
const loadingSpinner = document.getElementById('loadingSpinner');


// MAP INITIALIZATION
function initMap() {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(myMap);
}



// HANDLE IMAGE INPUT
async function handleImageInput(input) {
    if (!input.files || input.files.length === 0) return;

    if (input.files.length > 1) clearMap(false);

    loadingSpinner.style.display = 'block';

    for (let i = 0; i < input.files.length; i++) {
        await processImageFile(input.files[i]);
    }

    updatePhotoCards();
    await drawPaths();
    updateTimeDifferences();

    loadingSpinner.style.display = 'none';
}



// PROCESS EACH IMAGE FILE
async function processImageFile(file) {
    return new Promise(resolve => {
        const reader = new FileReader();

        reader.onload = function (e) {
            EXIF.getData(file, function () {

                const lat = EXIF.getTag(this, "GPSLatitude");
                const lon = EXIF.getTag(this, "GPSLongitude");
                const date = EXIF.getTag(this, "DateTimeOriginal");

                if (!lat || !lon) return resolve();

                const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "W";

                const calculatedLat =
                    (lat[0] + lat[1] / 60 + lat[2] / 3600) *
                    (latRef === "N" ? 1 : -1);

                const calculatedLon =
                    (lon[0] + lon[1] / 60 + lon[2] / 3600) *
                    (lonRef === "W" ? -1 : 1);

                let dateObj = null;
                if (date) {
                    const parts = date.split(" ");
                    const dateString = parts[0].replace(/:/g, "-") + "T" + parts[1];
                    dateObj = new Date(dateString);
                }

                const photo = {
                    id: Date.now() + Math.random(),
                    file,
                    src: e.target.result,
                    lat: calculatedLat,
                    lon: calculatedLon,
                    dateObj,
                    formattedDate: dateObj ? dateObj.toLocaleString() : "Unknown",
                    filename: file.name
                };

                // INSERT INTO LINKED LIST HERE
                photoList.insert(photo);

                resolve();
            });
        };

        reader.readAsDataURL(file);
    });
}



// UPDATE PHOTO CARDS FROM LINKED LIST
function updatePhotoCards() {
    const container = document.getElementById("photoCards");
    container.innerHTML = "";

    photoList.forEach(photo => {
        const card = document.createElement("div");
        card.className = "col photo-card";
        card.setAttribute("onclick", `focusOnPhoto('${photo.id}')`);

        card.innerHTML = `
            <div class="row g-0">
                <div class="col-8">
                    <img src="${photo.src}" class="fixed-img" />
                </div>
                <div class="col-4 p-2">
                    <strong>${photo.filename}</strong><br>
                    ${photo.formattedDate}<br>
                    <small>${photo.lat.toFixed(6)}, ${photo.lon.toFixed(6)}</small>
                </div>
            </div>
            <hr>
        `;
        container.appendChild(card);
    });
}



// FOCUS ON A PHOTO  
function focusOnPhoto(id) {
    const photo = photoList.findById(id);
    if (!photo) return;

    myMap.setView([photo.lat, photo.lon], 15);

    const marker = markers.find(m => m.photoId == id);
    if (marker) marker.openPopup();
}



// DRAW PATHS USING LINKED LIST  
async function drawPaths() {
    markers.forEach(m => myMap.removeLayer(m));
    markers = [];

    if (pathPolyline) {
        myMap.removeLayer(pathPolyline);
        pathPolyline = null;
    }

    const arr = photoList.toArray();
    if (arr.length < 1) return;

    // Sort by date
    arr.sort((a, b) => a.dateObj - b.dateObj);

    arr.forEach(photo => {
        const marker = L.marker([photo.lat, photo.lon])
            .addTo(myMap)
            .bindPopup(`<b>${photo.filename}</b><br>${photo.formattedDate}`);
        marker.photoId = photo.id;
        markers.push(marker);
    });

    if (arr.length < 2) return;

    const coords = arr.map(p => `${p.lon},${p.lat}`).join(';');

    try {
        const res = await fetch(
            `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`
        );
        const data = await res.json();

        const path = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);

        pathPolyline = L.polyline(path, { color: "blue", weight: 4 })
            .addTo(myMap);

        myMap.fitBounds(pathPolyline.getBounds());

    } catch (e) {
        console.log("OSRM failed, drawing straight lines.");

        const fallback = arr.map(p => [p.lat, p.lon]);
        pathPolyline = L.polyline(fallback, { color: "red", weight: 3 })
            .addTo(myMap);

        myMap.fitBounds(pathPolyline.getBounds());
    }
}

// ============================================
// FULL TIME DIFFERENCE FUNCTION (Y M D H M S)
// ============================================
function diffYMDHMS(startDate, endDate) {
    let s = new Date(startDate);
    let e = new Date(endDate);

    if (s > e) [s, e] = [e, s];

    let years  = e.getFullYear() - s.getFullYear();
    let months = e.getMonth() - s.getMonth();
    let days   = e.getDate() - s.getDate();
    let hours  = e.getHours() - s.getHours();
    let mins   = e.getMinutes() - s.getMinutes();
    let secs   = e.getSeconds() - s.getSeconds();

    // Normalize
    if (secs < 0) { secs += 60; mins--; }
    if (mins < 0) { mins += 60; hours--; }
    if (hours < 0) { hours += 24; days--; }

    if (days < 0) {
        const prevMonthDays = new Date(e.getFullYear(), e.getMonth(), 0).getDate();
        days += prevMonthDays;
        months--;
    }

    if (months < 0) {
        months += 12;
        years--;
    }

    return { years, months, days, hours, mins, secs };
}

// TIME DIFFERENCE CALCULATION
function updateTimeDifferences() {
    const arr = photoList.toArray().filter(p => p.dateObj);
    if (arr.length < 2) return;

    arr.sort((a, b) => a.dateObj - b.dateObj);

    const first = arr[0].dateObj;
    const last = arr[arr.length - 1].dateObj;

    // Use full Y M D H M S difference
    const diff = diffYMDHMS(first, last);

    const formatted = 
        `${diff.years}y ${diff.months}m ${diff.days}d ` +
        `${diff.hours}h ${diff.mins}m ${diff.secs}s`;

    document.getElementById("timeDifference").innerText = formatted;
    document.getElementById("timeInfo").style.display = "block";
}



// CLEAR MAP + LINKED LIST
function clearMap(resetInput = true) {
    markers.forEach(m => myMap.removeLayer(m));
    markers = [];

    if (pathPolyline) {
        myMap.removeLayer(pathPolyline);
        pathPolyline = null;
    }

    // CLEAR LINKED LIST  
    photoList.clear();

    document.getElementById("photoCards").innerHTML = "";
    document.getElementById("pathInfo").style.display = "none";
    document.getElementById("timeInfo").style.display = "none";

    if (resetInput) document.getElementById("imageInput").value = "";

    myMap.setView([11.635230398105993, 123.70790316297406], 5);
}

document.addEventListener("DOMContentLoaded", initMap);

</script>

</body>
</html>